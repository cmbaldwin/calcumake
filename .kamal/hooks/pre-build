#!/bin/bash
# Kamal pre-build hook
#
# Translation behavior:
#   - By default: Only translates NEW/MISSING keys (uses cache)
#   - To force retranslation: kamal deploy -e FORCE_RETRANSLATE=1
#
# This hook will:
#   1. Load OpenRouter API key from .env.local or Kamal secrets
#   2. Optionally clear cache for English placeholders (if FORCE_RETRANSLATE=1)
#   3. Sync and translate missing keys only
#   4. Run tests
#   5. Commit and push changes if any

# Redirect all output to stderr so Kamal shows it
exec 1>&2

# Enable verbose output
set -x

# Load environment variables from .env.local if it exists (for local testing)
if [ -f .env.local ]; then
    echo "Loading environment from .env.local..."
    set -a
    source .env.local
    set +a
fi

# If still not set, try to fetch from Kamal secrets (for deployment)
if [ -z "$OPENROUTER_TRANSLATION_KEY" ]; then
    echo "Loading OpenRouter API key from Kamal secrets..."
    export OPENROUTER_TRANSLATION_KEY=$(kamal secrets extract CALCUMAKE_OPENROUTER_TRANSLATION_KEY $(kamal secrets fetch --adapter 1password --account CNCYFLWUMZHE7MBS5AAOOSTLTI --from "MOAB/Production" CALCUMAKE_OPENROUTER_TRANSLATION_KEY))
fi

if [ -z "$OPENROUTER_TRANSLATION_KEY" ]; then
    echo "âŒ Failed to load OPENROUTER_TRANSLATION_KEY"
    echo "   Make sure it's set in .env.local or Kamal secrets"
    exit 1
fi

echo "âœ“ OpenRouter API key loaded successfully"

# Check if FORCE_RETRANSLATE flag is set (e.g., kamal deploy --env FORCE_RETRANSLATE=1)
if [ "$FORCE_RETRANSLATE" = "1" ] || [ "$FORCE_RETRANSLATE" = "true" ]; then
    echo "ðŸ”„ FORCE_RETRANSLATE flag detected - clearing cache for English placeholders..."
    if ! bin/force-retranslate; then
        echo "âŒ Failed to clear translation cache"
        exit 1
    fi
else
    echo "â„¹ï¸  Skipping force-retranslate (set FORCE_RETRANSLATE=1 to force retranslation)"
fi

# Sync translations with automated translation - MUST have API key
# This will only translate NEW/MISSING keys, not re-translate cached ones
echo "Syncing and translating missing keys..."
if ! bin/sync-translations; then
    echo "âŒ Translation sync failed!"
    echo "   This is a critical error - deployment cannot proceed without translations"
    echo "   Check that OPENROUTER_TRANSLATION_KEY is set in Kamal secrets"
    exit 1
fi

# Check if translations created any changes
if ! git diff-index --quiet HEAD -- config/locales/; then
    echo "âœ… Translation sync created changes. Staging locale files..."
    git add config/locales/
else
    echo "âœ… No new translations needed (all keys cached)"
    echo "ðŸ’¡ Tip: To force retranslation of all keys, run: kamal deploy -e FORCE_RETRANSLATE=1"
fi

# Run tests first - ensure they pass before proceeding
echo "Running tests..."
bin/rails test

# Only proceed if tests passed
if [ $? -eq 0 ]; then
    echo "Tests passed. Checking for uncommitted changes..."
    
    # Check if there are any changes to commit
    if ! git diff-index --quiet HEAD --; then
        echo "Found uncommitted changes. Adding and committing..."
        
        # Stage all files
        git add .
        
        # Generate commit message using Claude
        echo "Generating descriptive commit message using Claude..."
        
        # Get git status and diff for Claude to analyze
        git_status=$(git status --porcelain)
        git_diff=$(git diff --staged --stat)
        
        # Use Claude to generate commit message
        commit_message=$(claude --prompt "Based on the following git changes, write a concise commit message (1-2 lines) describing what was changed:

Git status:
$git_status

Git diff summary:
$git_diff

Format: Start with a verb in imperative mood (add, update, fix, etc.) and be specific about what changed." 2>/dev/null || echo "Update files for deployment")
        
        # Log the generated commit message
        echo "Claude generated commit message: $commit_message"
        
        # Create commit with Claude-generated message and attribution
        full_commit_message="$commit_message

ðŸ¤– Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>"
        
        echo "Creating commit with full message:"
        echo "$full_commit_message"
        echo "---"
        
        git commit -m "$full_commit_message"
        
        # Push to current branch
        echo "Pushing changes..."
        git push origin HEAD
        
        echo "Changes committed and pushed successfully."
    else
        echo "No uncommitted changes found."
    fi
else
    echo "Tests failed. Aborting deployment."
    exit 1
fi