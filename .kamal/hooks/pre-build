#!/bin/bash

# Clear cache for keys with English placeholder values
echo "Checking for untranslated placeholders..."
bin/force-retranslate

# Sync translations with automated translation if API key available
echo "Syncing and translating all missing keys..."
bin/sync-translations

# Check if translations created any changes
if ! git diff-index --quiet HEAD -- config/locales/; then
    echo "Translation sync created changes. Staging locale files..."
    git add config/locales/
fi

# Run tests first - ensure they pass before proceeding
echo "Running tests..."
bin/rails test

# Only proceed if tests passed
if [ $? -eq 0 ]; then
    echo "Tests passed. Checking for uncommitted changes..."
    
    # Check if there are any changes to commit
    if ! git diff-index --quiet HEAD --; then
        echo "Found uncommitted changes. Adding and committing..."
        
        # Stage all files
        git add .
        
        # Generate commit message using Claude
        echo "Generating descriptive commit message using Claude..."
        
        # Get git status and diff for Claude to analyze
        git_status=$(git status --porcelain)
        git_diff=$(git diff --staged --stat)
        
        # Use Claude to generate commit message
        commit_message=$(claude --prompt "Based on the following git changes, write a concise commit message (1-2 lines) describing what was changed:

Git status:
$git_status

Git diff summary:
$git_diff

Format: Start with a verb in imperative mood (add, update, fix, etc.) and be specific about what changed." 2>/dev/null || echo "Update files for deployment")
        
        # Log the generated commit message
        echo "Claude generated commit message: $commit_message"
        
        # Create commit with Claude-generated message and attribution
        full_commit_message="$commit_message

ðŸ¤– Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>"
        
        echo "Creating commit with full message:"
        echo "$full_commit_message"
        echo "---"
        
        git commit -m "$full_commit_message"
        
        # Push to current branch
        echo "Pushing changes..."
        git push origin HEAD
        
        echo "Changes committed and pushed successfully."
    else
        echo "No uncommitted changes found."
    fi
else
    echo "Tests failed. Aborting deployment."
    exit 1
fi