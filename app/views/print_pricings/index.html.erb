<%# Usage Dashboard Widget %>
<%= render 'shared/usage_dashboard_widget' %>

<!-- Header Section with Quick Calculator -->
<div class="d-flex flex-column flex-lg-row align-items-center align-items-lg-start justify-content-lg-center mb-5 gap-4">
    <!-- Left Side: Title and CTA -->
    <div class="flex-grow-1 text-center text-lg-start mb-4 mb-lg-0">
        <h3 class="display-5 fw-bold text-primary mb-3"><%= t('print_pricing.index.title') %></h3>
        <p class="lead text-muted mb-4">
            <%= t('print_pricing.index.subtitle') %>
        </p>
        <%= link_to t('print_pricing.index.create_new'), new_print_pricing_path, class: "btn btn-primary btn-lg" %>
    </div>

    <!-- Right Side: Quick Calculator (Desktop) / Below Header (Mobile) -->
    <div class="flex-shrink-0" style="width: 100%; max-width: 400px;">
        <%= quick_calculator(energy_cost: current_user&.default_energy_cost_per_kwh || 0.12) %>
    </div>
</div>

<!-- Search Section -->
<div class="mb-4" data-controller="search" data-search-url-value="<%= print_pricings_path %>">
    <%= search_form_for @q, url: print_pricings_path,
        html: {
          data: {
            turbo_frame: :print_pricings_results,
            search_target: "form"
          }
        } do |form| %>
        <%= form.search_field :job_name_cont,
            placeholder: t('print_pricing.index.search_placeholder'),
            class: "form-control",
            data: {
              search_target: "input",
              action: "input->search#search"
            } %>

        <!-- Date Range Filter -->
        <%= render Shared::DateRangeFilterComponent.new(form: form) %>
    <% end %>
</div>

<%= turbo_frame_tag :print_pricings_results do %>
    <% if @print_pricings.any? %>
        <%= turbo_frame_tag "stats_cards" do %>
            <div id="stats_cards_content">
                <%= render "shared/components/stats_cards", print_pricings: @print_pricings %>
            </div>
        <% end %>

        <!-- Analytics Charts (only shown when date filter is active) -->
        <% if defined?(@analytics) && @analytics %>
          <div class="row g-3 mb-4">
            <div class="col-12 col-lg-6">
              <%= render Analytics::ChartComponent.new(
                title: "Revenue Over Time",
                chart_data: revenue_chart_data(@analytics),
                chart_type: "line"
              ) %>
            </div>
            <div class="col-12 col-lg-6">
              <%= render Analytics::ChartComponent.new(
                title: "Print Volume Over Time",
                chart_data: prints_chart_data(@analytics),
                chart_type: "line"
              ) %>
            </div>
          </div>
        <% end %>

        <div class="row g-3">
            <% @print_pricings.each do |pricing| %>
                <%= render Cards::PricingCardComponent.new(pricing: pricing) %>
            <% end %>
        </div>
    <% else %>
        <% if params.dig(:q, :job_name_cont).present? %>
            <%= render Shared::EmptyStateComponent.new(
              title: t('print_pricing.index.no_results.title'),
              description: t('print_pricing.index.no_results.description', query: params.dig(:q, :job_name_cont))
            ) %>
        <% else %>
            <%= render Shared::EmptyStateComponent.new(
              title: t('print_pricing.index.empty_state.title'),
              description: t('print_pricing.index.empty_state.description'),
              action_text: t('print_pricing.index.create_new'),
              action_url: new_print_pricing_path
            ) %>
        <% end %>
    <% end %>
<% end %>