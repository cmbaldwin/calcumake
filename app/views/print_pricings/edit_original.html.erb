<div class="calculator-header" style="text-align: center; margin-bottom: 3rem;">
  <h1 style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.8rem; font-weight: 800;">
    Edit Print Pricing
  </h1>
  <p style="color: var(--text-secondary); font-size: 1.1rem;">
    Refine your 3D printing cost calculation
  </p>
</div>

<%= form_with model: @print_pricing, local: true, html: { id: "pricing-form" } do |form| %>
  <% if @print_pricing.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@print_pricing.errors.count, "error") %> prohibited this pricing from being saved:</h2>
      <ul>
        <% @print_pricing.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="column column-50">
      <label for="job_name">Job Name</label>
      <%= form.text_field :job_name, placeholder: "e.g., Miniature Model" %>
    </div>
    <div class="column column-50">
      <label for="currency">Select your currency</label>
      <%= form.select :currency, 
          options_for_select(currency_options, @print_pricing.currency), 
          { prompt: "Select currency" } %>
    </div>
  </div>

  <h3>Printing Time</h3>
  <div class="row">
    <div class="column column-25">
      <label for="printing_time_hours">Hours</label>
      <%= form.number_field :printing_time_hours, min: 0, step: 1, value: @print_pricing.printing_time_hours || 0 %>
    </div>
    <div class="column column-25">
      <label for="printing_time_minutes">Minutes</label>
      <%= form.number_field :printing_time_minutes, min: 0, max: 59, step: 1, value: @print_pricing.printing_time_minutes || 0 %>
    </div>
    <div class="column column-50">
      <label for="filament_weight">Filament Weight (g)</label>
      <%= form.number_field :filament_weight, step: 0.1, placeholder: "36" %>
    </div>
  </div>

  <h3>Filament</h3>
  <div class="row">
    <div class="column column-25">
      <label for="filament_type">Filament Type</label>
      <%= form.select :filament_type, 
          options_for_select([
            ['PLA', 'PLA'],
            ['ABS', 'ABS'],
            ['PETG', 'PETG'],
            ['TPU', 'TPU'],
            ['ASA', 'ASA'],
            ['Other', 'Other']
          ], @print_pricing.filament_type), 
          { prompt: "Select type" } %>
    </div>
    <div class="column column-25">
      <label for="spool_price">Spool Price</label>
      <%= form.number_field :spool_price, step: 0.01, placeholder: "25.00" %>
    </div>
    <div class="column column-25">
      <label for="spool_weight">Spool Weight (g)</label>
      <%= form.number_field :spool_weight, step: 0.1, placeholder: "1000" %>
    </div>
    <div class="column column-25">
      <label for="markup_percentage">Markup (%)</label>
      <%= form.number_field :markup_percentage, step: 0.1, placeholder: "20" %>
    </div>
  </div>

  <div id="filament-cost" class="calculation-display">
    Total filament cost: <span class="currency"></span> <span class="amount">0.00</span>
  </div>

  <h3>Electricity (Optional)</h3>
  <div class="row">
    <div class="column column-50">
      <label for="power_consumption">Power Consumption (W)</label>
      <%= form.number_field :power_consumption, step: 1, placeholder: "200" %>
    </div>
    <div class="column column-50">
      <label for="energy_cost_per_kwh">Energy Cost per kWh</label>
      <%= form.number_field :energy_cost_per_kwh, step: 0.001, placeholder: "0.12" %>
    </div>
  </div>

  <div id="electricity-cost" class="calculation-display">
    Total electricity cost: <span class="currency"></span> <span class="amount">0.00</span>
  </div>

  <h3>Labor Cost (Optional)</h3>
  <div class="row">
    <div class="column column-25">
      <label>Print Preparation Time (Min.)</label>
      <%= form.number_field :prep_time_minutes, min: 0, step: 1, placeholder: "30" %>
    </div>
    <div class="column column-25">
      <label>Cost per Hour</label>
      <%= form.number_field :prep_cost_per_hour, step: 0.01, placeholder: "20.00" %>
    </div>
    <div class="column column-25">
      <label>Postprocessing Time (Min.)</label>
      <%= form.number_field :postprocessing_time_minutes, min: 0, step: 1, placeholder: "30" %>
    </div>
    <div class="column column-25">
      <label>Cost per Hour</label>
      <%= form.number_field :postprocessing_cost_per_hour, step: 0.01, placeholder: "20.00" %>
    </div>
  </div>

  <div id="labor-cost" class="calculation-display">
    Total labor cost: <span class="currency"></span> <span class="amount">0.00</span>
  </div>

  <h3>Machine & upkeep cost (Optional)</h3>
  <div class="row">
    <div class="column column-25">
      <label for="printer_cost">Printer Cost</label>
      <%= form.number_field :printer_cost, step: 0.01, placeholder: "500.00" %>
    </div>
    <div class="column column-25">
      <label for="investment_return_years">Investment Return (Years)</label>
      <%= form.number_field :investment_return_years, min: 1, step: 1, placeholder: "3" %>
    </div>
    <div class="column column-25">
      <label for="daily_usage_hours">Daily commercial usage (h)</label>
      <%= form.number_field :daily_usage_hours, min: 1, step: 1, placeholder: "8" %>
    </div>
    <div class="column column-25">
      <label for="repair_cost_percentage">Repair Cost (%)</label>
      <%= form.number_field :repair_cost_percentage, step: 0.1, placeholder: "5" %>
    </div>
  </div>

  <div id="machine-cost" class="calculation-display">
    Total machine & upkeep cost: <span class="currency"></span> <span class="amount">0.00</span>
  </div>

  <h3>Other Costs</h3>
  <div class="row">
    <div class="column column-50">
      <label for="other_costs">Other Costs</label>
      <%= form.number_field :other_costs, step: 0.01, placeholder: "0.00" %>
    </div>
    <div class="column column-50">
      <label for="vat_percentage">VAT (%)</label>
      <%= form.number_field :vat_percentage, step: 0.1, placeholder: "10" %>
    </div>
  </div>

  <div id="final-price" class="final-price-display">
    <h2>Final price: <span class="currency"></span> <span class="amount">0.00</span></h2>
  </div>

  <div class="row">
    <div class="column">
      <%= form.submit "Calculate & Save", class: "button" %>
      <%= link_to "Cancel", print_pricings_path, class: "button button-clear" %>
    </div>
  </div>
<% end %>

<script>
// Real-time calculation updates
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('pricing-form');
  const inputs = form.querySelectorAll('input[type="number"], select');
  
  function updateCalculations() {
    const currency = document.getElementById('print_pricing_currency').value || '';
    
    // Define currencies without decimals
    const zeroDecimalCurrencies = ['JPY'];
    const useDecimals = !zeroDecimalCurrencies.includes(currency);
    
    // Helper function to format amounts
    function formatAmount(amount) {
      return useDecimals ? amount.toFixed(2) : Math.round(amount).toString();
    }
    
    // Update all currency displays
    document.querySelectorAll('.currency').forEach(el => el.textContent = currency);
    
    // Get values with fallbacks
    const filamentWeight = parseFloat(document.getElementById('print_pricing_filament_weight').value) || 0;
    const spoolPrice = parseFloat(document.getElementById('print_pricing_spool_price').value) || 0;
    const spoolWeight = parseFloat(document.getElementById('print_pricing_spool_weight').value) || 1000;
    const markupPercentage = parseFloat(document.getElementById('print_pricing_markup_percentage').value) || 0;
    
    // Calculate filament cost
    const filamentCost = spoolWeight > 0 ? (filamentWeight * spoolPrice / spoolWeight) * (1 + markupPercentage / 100) : 0;
    document.querySelector('#filament-cost .amount').textContent = formatAmount(filamentCost);
    
    // Calculate electricity cost
    const powerConsumption = parseFloat(document.getElementById('print_pricing_power_consumption').value) || 0;
    const energyCost = parseFloat(document.getElementById('print_pricing_energy_cost_per_kwh').value) || 0;
    const printingHours = (parseInt(document.getElementById('print_pricing_printing_time_hours').value) || 0);
    const printingMinutes = (parseInt(document.getElementById('print_pricing_printing_time_minutes').value) || 0);
    const totalPrintingMinutes = printingHours * 60 + printingMinutes;
    
    const electricityCost = (powerConsumption * totalPrintingMinutes / 60 / 1000) * energyCost;
    document.querySelector('#electricity-cost .amount').textContent = formatAmount(electricityCost);
    
    // Calculate labor cost
    const prepTime = parseFloat(document.getElementById('print_pricing_prep_time_minutes').value) || 0;
    const prepCost = parseFloat(document.getElementById('print_pricing_prep_cost_per_hour').value) || 0;
    const postTime = parseFloat(document.getElementById('print_pricing_postprocessing_time_minutes').value) || 0;
    const postCost = parseFloat(document.getElementById('print_pricing_postprocessing_cost_per_hour').value) || 0;
    
    const laborCost = (prepTime * prepCost / 60) + (postTime * postCost / 60);
    document.querySelector('#labor-cost .amount').textContent = formatAmount(laborCost);
    
    // Calculate machine cost
    const printerCost = parseFloat(document.getElementById('print_pricing_printer_cost').value) || 0;
    const investmentYears = parseInt(document.getElementById('print_pricing_investment_return_years').value) || 1;
    const dailyUsage = parseInt(document.getElementById('print_pricing_daily_usage_hours').value) || 8;
    const repairPercentage = parseFloat(document.getElementById('print_pricing_repair_cost_percentage').value) || 0;
    
    const totalDays = investmentYears * 365;
    const dailyDepreciation = printerCost / totalDays;
    const hourlyDepreciation = dailyDepreciation / dailyUsage;
    const repairFactor = 1 + repairPercentage / 100;
    const machineCost = hourlyDepreciation * (totalPrintingMinutes / 60) * repairFactor;
    
    document.querySelector('#machine-cost .amount').textContent = formatAmount(machineCost);
    
    // Calculate final price
    const otherCosts = parseFloat(document.getElementById('print_pricing_other_costs').value) || 0;
    const vatPercentage = parseFloat(document.getElementById('print_pricing_vat_percentage').value) || 0;
    
    const subtotal = filamentCost + electricityCost + laborCost + machineCost + otherCosts;
    const finalPrice = subtotal * (1 + vatPercentage / 100);
    
    document.querySelector('#final-price .amount').textContent = formatAmount(finalPrice);
  }
  
  inputs.forEach(input => {
    input.addEventListener('input', updateCalculations);
    input.addEventListener('change', updateCalculations);
  });
  
  // Initial calculation
  updateCalculations();
});
</script>

<style>
.calculation-display, .final-price-display {
  padding: 1rem;
  margin: 1rem 0;
  background-color: #f8f9fa;
  border-left: 4px solid #007bff;
  border-radius: 4px;
}

.final-price-display {
  background-color: #d4edda;
  border-left-color: #28a745;
  text-align: center;
}

.final-price-display h2 {
  margin: 0;
  color: #155724;
}

#error_explanation {
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 4px;
  padding: 1rem;
  margin: 1rem 0;
}

#error_explanation h2 {
  color: #721c24;
  margin-top: 0;
}

#error_explanation ul {
  margin-bottom: 0;
  color: #721c24;
}
</style>
