<div class="nested-form-item card mb-3" data-nested-form-target="item" data-plate data-plate-id="<%= f.object.object_id %>"
     data-controller="plate-technology"
     data-plate-technology-current-value="<%= f.object.material_technology || 'fdm' %>">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h6 class="mb-0">
      <%= t('print_pricing.sections.plate') %>
      <span class="plate-number badge bg-secondary"></span>
    </h6>
    <button type="button"
            class="btn btn-sm btn-outline-danger"
            data-action="nested-form#remove">
      <%= t('actions.delete') %>
    </button>
  </div>
  <div class="card-body">
    <%= f.hidden_field :_destroy %>
    <%= f.hidden_field :material_technology, data: { plate_technology_target: "hiddenField" } %>

    <div class="row g-3">
      <!-- Technology Toggle -->
      <div class="col-12">
        <label class="form-label"><%= t('print_pricing.fields.material_technology') %></label>
        <div class="btn-group w-100" role="group" aria-label="<%= t('print_pricing.fields.material_technology') %>">
          <button type="button"
                  class="btn <%= f.object.fdm? || f.object.material_technology.nil? ? 'btn-primary active' : 'btn-outline-secondary' %>"
                  data-action="click->plate-technology#setTechnology"
                  data-technology="fdm"
                  data-plate-technology-target="toggleButton">
            <i class="bi bi-funnel me-1"></i> <%= t('print_pricing.technology.fdm') %>
          </button>
          <button type="button"
                  class="btn <%= f.object.resin? ? 'btn-primary active' : 'btn-outline-secondary' %>"
                  data-action="click->plate-technology#setTechnology"
                  data-technology="resin"
                  data-plate-technology-target="toggleButton">
            <i class="bi bi-droplet me-1"></i> <%= t('print_pricing.technology.resin') %>
          </button>
        </div>
      </div>

      <!-- Print Time -->
      <div class="col-12">
        <div class="row g-2">
          <div class="col-md-3">
            <%= f.label :printing_time_hours, t('print_pricing.fields.print_time_hours'), class: "form-label" %>
            <%= f.number_field :printing_time_hours, min: 0, step: 1, value: f.object.printing_time_hours || 0, class: "form-control" %>
          </div>
          <div class="col-md-3">
            <%= f.label :printing_time_minutes, t('print_pricing.fields.print_time_minutes'), class: "form-label" %>
            <%= f.number_field :printing_time_minutes, min: 0, max: 59, step: 1, value: f.object.printing_time_minutes || 0, class: "form-control" %>
          </div>
        </div>
      </div>

      <!-- Filaments Section (FDM) -->
      <div class="col-12" data-plate-technology-target="fdmFields"
           style="<%= f.object.resin? ? 'display: none;' : '' %>"
           data-controller="filament-list"
           data-plate-filament-container="<%= f.object.object_id %>"
           data-filament-list-max-items-value="16"
           data-filament-list-min-items-value="1"
           data-filament-list-item-name-value="filament"
           data-filament-list-add-button-text-value="<%= t('filaments.buttons.add_filament') %>"
           data-filament-list-currency-symbol-value="<%= currency_symbol(current_user.default_currency) %>"
           data-filament-list-dynamic-list-outlet=".filament-dynamic-list">

        <div class="filament-dynamic-list" data-controller="dynamic-list">
          <div class="mb-3">
            <h6 class="mb-0"><%= t('print_pricing.sections.filaments') %></h6>
          </div>

          <div data-filament-list-target="container" data-dynamic-list-target="container">
            <%= f.fields_for :plate_filaments do |pf_form| %>
              <%= render 'print_pricings/plate_filament_fields', f: pf_form, user_filaments: current_user.filaments %>
            <% end %>
          </div>

          <!-- Template for new filaments -->
          <template data-filament-list-target="template" data-dynamic-list-target="template">
            <%= f.fields_for :plate_filaments, PlateFilament.new, child_index: 'NEW_RECORD' do |pf_form| %>
              <%= render 'print_pricings/plate_filament_fields', f: pf_form, user_filaments: current_user.filaments %>
            <% end %>
          </template>

          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="form-text mb-0">
              <%= t('print_pricing.help.filaments_limit') %>
            </div>
            <button type="button"
                    class="btn btn-sm btn-success"
                    data-action="filament-list#add"
                    data-dynamic-list-target="addButton">
              + <%= t('filaments.buttons.add_filament') %>
            </button>
          </div>
        </div>
      </div>

      <!-- Resin Section (SLA/DLP) - Single resin per plate -->
      <div class="col-12" data-plate-technology-target="resinFields"
           style="<%= f.object.fdm? || f.object.material_technology.nil? ? 'display: none;' : '' %>">
        <div class="mb-3">
          <h6 class="mb-0"><%= t('print_pricing.sections.resins') %></h6>
        </div>

        <%# Build a single plate_resin if none exists %>
        <% if f.object.plate_resins.empty? %>
          <% f.object.plate_resins.build %>
        <% end %>

        <%= f.fields_for :plate_resins do |pr_form| %>
          <%= render 'print_pricings/plate_resin_fields', f: pr_form, user_resins: current_user.resins, single_resin: true %>
        <% end %>
      </div>
    </div>
  </div>
</div>
