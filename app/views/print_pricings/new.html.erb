<% content_for :body_class, "pricing-form-page" %>

<!-- Calculator Header -->
<div class="text-center mb-4">
  <h1 class="display-5 fw-bold text-primary mb-2"><%= t('print_pricing.calculator.title') %></h1>
  <p class="lead text-muted"><%= t('print_pricing.calculator.subtitle') %></p>
</div>

<%= form_with model: @print_pricing, local: true, html: { id: "pricing-form", class: "row g-3" } do |form| %>
  <% if @print_pricing.errors.any? %>
    <div class="col-12">
      <div class="alert alert-danger">
        <h4><%= t('common.errors_prohibited', count: @print_pricing.errors.count, errors: t('common.error_count', count: @print_pricing.errors.count), model: t('models.print_pricing')) %></h4>
        <ul class="mb-0">
          <% @print_pricing.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <!-- Basic Information -->
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><%= t('print_pricing.sections.basic_info') %></h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <%= form.label :job_name, class: "form-label" %>
            <%= form.text_field :job_name, class: "form-control", placeholder: t('print_pricing.fields.job_name_placeholder') %>
          </div>
          <div class="col-md-6">
            <%= form.label :printer_id, t('print_pricing.fields.select_printer'), class: "form-label" %>
            <%= form.select :printer_id,
                options_from_collection_for_select(current_user.printers, :id, :name, @print_pricing.printer_id),
                { prompt: t('print_pricing.fields.select_printer_prompt') },
                { class: "form-select" } %>
            <div class="form-text">
              <%= t('print_pricing.fields.no_printer_help') %>
              <%= link_to t('print_pricing.fields.add_printer_link'), new_printer_path,
                  class: "text-primary",
                  data: {
                    confirm: "Warning: You will lose any unsaved progress on this form. Continue?"
                  } %>
            </div>
          </div>
          <div class="col-12">
            <div class="form-check form-switch">
              <%= form.check_box :start_with_one_print,
                  { checked: false, class: "form-check-input" },
                  "1", "0" %>
              <label class="form-check-label" for="<%= form.field_id(:start_with_one_print) %>">
                <%= t('print_pricing.fields.start_with_one_print') %>
              </label>
              <div class="form-text"><%= t('print_pricing.fields.start_with_one_print_help') %></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Print Time & Material -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0"><%= t('print_pricing.sections.print_time_material') %></h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6">
            <%= form.label :printing_time_hours, t('print_pricing.fields.print_time_hours'), class: "form-label" %>
            <%= form.number_field :printing_time_hours, min: 0, step: 1, value: @print_pricing.printing_time_hours || 0, class: "form-control" %>
          </div>
          <div class="col-6">
            <%= form.label :printing_time_minutes, t('print_pricing.fields.print_time_minutes'), class: "form-label" %>
            <%= form.number_field :printing_time_minutes, min: 0, max: 59, step: 1, value: @print_pricing.printing_time_minutes || 0, class: "form-control" %>
          </div>
          <div class="col-12">
            <%= form.label :filament_weight, t('print_pricing.fields.filament_weight'), class: "form-label" %>
            <%= form.number_field :filament_weight, step: 0.1, placeholder: t('print_pricing.fields.filament_weight_placeholder'), class: "form-control" %>
          </div>
          <div class="col-12">
            <%= form.label :filament_type, t('print_pricing.fields.filament_type'), class: "form-label" %>
            <%= form.select :filament_type,
                options_for_select([
                  [t('print_pricing.filament_types.pla'), 'PLA'],
                  [t('print_pricing.filament_types.abs'), 'ABS'],
                  [t('print_pricing.filament_types.petg'), 'PETG'],
                  [t('print_pricing.filament_types.tpu'), 'TPU'],
                  [t('print_pricing.filament_types.asa'), 'ASA'],
                  [t('print_pricing.filament_types.other'), 'Other']
                ], @print_pricing.filament_type),
                { prompt: t('print_pricing.fields.filament_type_prompt') },
                { class: "form-select" } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filament Costs -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0"><%= t('print_pricing.sections.filament_details') %></h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <%= form.label :spool_price, t('print_pricing.fields.spool_price'), class: "form-label" %>
            <div class="input-group">
              <span class="input-group-text"><%= currency_symbol(current_user.default_currency) %></span>
              <%= form.number_field :spool_price, step: 0.01, placeholder: t('print_pricing.fields.spool_price_placeholder'), class: "form-control" %>
            </div>
          </div>
          <div class="col-12">
            <%= form.label :spool_weight, t('print_pricing.fields.spool_weight'), class: "form-label" %>
            <%= form.number_field :spool_weight, step: 0.1, placeholder: t('print_pricing.fields.spool_weight_placeholder'), class: "form-control" %>
          </div>
          <div class="col-12">
            <%= form.label :markup_percentage, t('print_pricing.fields.markup_percentage'), class: "form-label" %>
            <%= form.number_field :markup_percentage, step: 0.1, placeholder: t('print_pricing.fields.markup_placeholder'), class: "form-control" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Electricity Cost -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0"><%= t('print_pricing.sections.electricity') %></h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <p class="mb-2"><strong><%= t('print_pricing.sections.electricity_auto_calculated') %></strong></p>
          <ul class="mb-2">
            <li><%= t('print_pricing.sections.electricity_power_consumption') %></li>
            <li><%= t('print_pricing.sections.electricity_print_time') %></li>
            <li><%= t('print_pricing.sections.electricity_energy_cost', cost: "#{currency_symbol(current_user.default_currency)}#{current_user.default_energy_cost_per_kwh}/kWh") %></li>
          </ul>
          <small><%= t('print_pricing.sections.electricity_settings_link_html', link: link_to(t('print_pricing.sections.profile_settings'), user_profile_path, class: "text-primary")) %></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Labor Cost -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0"><%= t('print_pricing.sections.labor') %></h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6">
            <%= form.label :prep_time_minutes, t('print_pricing.fields.prep_time_minutes'), class: "form-label" %>
            <%= form.number_field :prep_time_minutes, min: 0, step: 1, placeholder: t('print_pricing.fields.prep_time_placeholder'), class: "form-control" %>
          </div>
          <div class="col-6">
            <%= form.label :prep_cost_per_hour, t('print_pricing.fields.prep_cost_per_hour'), class: "form-label" %>
            <div class="input-group">
              <span class="input-group-text"><%= currency_symbol(current_user.default_currency) %></span>
              <%= form.number_field :prep_cost_per_hour, step: 0.01, placeholder: t('print_pricing.fields.prep_cost_placeholder'), class: "form-control" %>
            </div>
          </div>
          <div class="col-6">
            <%= form.label :postprocessing_time_minutes, t('print_pricing.fields.postprocessing_time_minutes'), class: "form-label" %>
            <%= form.number_field :postprocessing_time_minutes, min: 0, step: 1, placeholder: t('print_pricing.fields.postprocessing_time_placeholder'), class: "form-control" %>
          </div>
          <div class="col-6">
            <%= form.label :postprocessing_cost_per_hour, t('print_pricing.fields.postprocessing_cost_per_hour'), class: "form-label" %>
            <div class="input-group">
              <span class="input-group-text"><%= currency_symbol(current_user.default_currency) %></span>
              <%= form.number_field :postprocessing_cost_per_hour, step: 0.01, placeholder: t('print_pricing.fields.postprocessing_cost_placeholder'), class: "form-control" %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Machine & Upkeep -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0"><%= t('print_pricing.sections.machine_upkeep') %></h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <p class="mb-2"><strong><%= t('print_pricing.sections.machine_auto_calculated') %></strong></p>
          <ul class="mb-2">
            <li><%= t('print_pricing.sections.machine_cost_usage') %></li>
            <li><%= t('print_pricing.sections.machine_return_period') %></li>
            <li><%= t('print_pricing.sections.machine_repair_factor') %></li>
          </ul>
          <small><%= t('print_pricing.sections.machine_printer_config_html', link: link_to(t('print_pricing.sections.add_edit_printer'), new_printer_path, class: "text-primary", data: { confirm: t('print_pricing.sections.unsaved_progress_warning') })) %></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Costs -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0"><%= t('print_pricing.sections.other_costs_tax') %></h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <%= form.label :other_costs, t('print_pricing.fields.other_costs'), class: "form-label" %>
            <div class="input-group">
              <span class="input-group-text"><%= currency_symbol(current_user.default_currency) %></span>
              <%= form.number_field :other_costs, step: 0.01, placeholder: t('print_pricing.fields.other_costs_placeholder'), class: "form-control" %>
            </div>
          </div>
          <div class="col-12">
            <%= form.label :vat_percentage, t('print_pricing.fields.vat_percentage'), class: "form-label" %>
            <%= form.number_field :vat_percentage, step: 0.1, placeholder: t('print_pricing.fields.vat_placeholder'), class: "form-control" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="col-12">
    <div class="d-flex gap-3 justify-content-center pt-3 border-top">
      <%= form.submit t('print_pricing.buttons.calculate_save'), class: "btn btn-primary btn-lg" %>
      <%= link_to t('print_pricing.buttons.cancel'), print_pricings_path, class: "btn btn-outline-secondary btn-lg" %>
    </div>
  </div>
<% end %>