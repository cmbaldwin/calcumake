<%# Usage statistics for current plan
  Required locals:
  - usage: hash with current, limit, and percentage for each resource type
%>

<div class="card">
  <div class="card-header">
    <h3 class="h6 mb-0">
      <i class="bi bi-bar-chart"></i>
      <%= t('usage_limits.usage_summary') %>
    </h3>
  </div>
  <div class="card-body">
    <div class="row">
      <%# Print Calculations Usage %>
      <div class="col-md-6 col-lg-3 mb-3">
        <div class="usage-stat">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small"><%= t('models.print_pricing_plural', default: 'Print Calculations') %></span>
            <span class="badge bg-secondary">
              <% if usage[:print_pricings][:limit] == Float::INFINITY %>
                <%= t('usage_limits.unlimited') %>
              <% else %>
                <%= usage[:print_pricings][:current] %>/<%= usage[:print_pricings][:limit] %>
              <% end %>
            </span>
          </div>
          <% if usage[:print_pricings][:limit] != Float::INFINITY %>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar <%= usage[:print_pricings][:percentage] >= 80 ? 'bg-warning' : 'bg-success' %>"
                   role="progressbar"
                   style="width: <%= [usage[:print_pricings][:percentage], 100].min %>%"
                   aria-valuenow="<%= usage[:print_pricings][:percentage] %>"
                   aria-valuemin="0"
                   aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted"><%= usage[:print_pricings][:percentage] %>% used</small>
          <% else %>
            <div class="text-success small">
              <i class="bi bi-infinity"></i> <%= t('usage_limits.unlimited') %>
            </div>
          <% end %>
        </div>
      </div>

      <%# Printers Usage %>
      <div class="col-md-6 col-lg-3 mb-3">
        <div class="usage-stat">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small"><%= t('models.printer_plural', default: 'Printers') %></span>
            <span class="badge bg-secondary">
              <% if usage[:printers][:limit] == Float::INFINITY %>
                <%= t('usage_limits.unlimited') %>
              <% else %>
                <%= usage[:printers][:current] %>/<%= usage[:printers][:limit] %>
              <% end %>
            </span>
          </div>
          <% if usage[:printers][:limit] != Float::INFINITY %>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar <%= usage[:printers][:percentage] >= 80 ? 'bg-warning' : 'bg-success' %>"
                   role="progressbar"
                   style="width: <%= [usage[:printers][:percentage], 100].min %>%"
                   aria-valuenow="<%= usage[:printers][:percentage] %>"
                   aria-valuemin="0"
                   aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted"><%= usage[:printers][:percentage] %>% used</small>
          <% else %>
            <div class="text-success small">
              <i class="bi bi-infinity"></i> <%= t('usage_limits.unlimited') %>
            </div>
          <% end %>
        </div>
      </div>

      <%# Filaments Usage %>
      <div class="col-md-6 col-lg-3 mb-3">
        <div class="usage-stat">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small"><%= t('models.filament_plural', default: 'Filaments') %></span>
            <span class="badge bg-secondary">
              <% if usage[:filaments][:limit] == Float::INFINITY %>
                <%= t('usage_limits.unlimited') %>
              <% else %>
                <%= usage[:filaments][:current] %>/<%= usage[:filaments][:limit] %>
              <% end %>
            </span>
          </div>
          <% if usage[:filaments][:limit] != Float::INFINITY %>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar <%= usage[:filaments][:percentage] >= 80 ? 'bg-warning' : 'bg-success' %>"
                   role="progressbar"
                   style="width: <%= [usage[:filaments][:percentage], 100].min %>%"
                   aria-valuenow="<%= usage[:filaments][:percentage] %>"
                   aria-valuemin="0"
                   aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted"><%= usage[:filaments][:percentage] %>% used</small>
          <% else %>
            <div class="text-success small">
              <i class="bi bi-infinity"></i> <%= t('usage_limits.unlimited') %>
            </div>
          <% end %>
        </div>
      </div>

      <%# Invoices Usage %>
      <div class="col-md-6 col-lg-3 mb-3">
        <div class="usage-stat">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small"><%= t('models.invoice_plural', default: 'Invoices') %></span>
            <span class="badge bg-secondary">
              <% if usage[:invoices][:limit] == Float::INFINITY %>
                <%= t('usage_limits.unlimited') %>
              <% else %>
                <%= usage[:invoices][:current] %>/<%= usage[:invoices][:limit] %>
              <% end %>
            </span>
          </div>
          <% if usage[:invoices][:limit] != Float::INFINITY %>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar <%= usage[:invoices][:percentage] >= 80 ? 'bg-warning' : 'bg-success' %>"
                   role="progressbar"
                   style="width: <%= [usage[:invoices][:percentage], 100].min %>%"
                   aria-valuenow="<%= usage[:invoices][:percentage] %>"
                   aria-valuemin="0"
                   aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted"><%= usage[:invoices][:percentage] %>% used</small>
          <% else %>
            <div class="text-success small">
              <i class="bi bi-infinity"></i> <%= t('usage_limits.unlimited') %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# Warning for approaching limits %>
    <% approaching = usage.select { |_k, v| v[:percentage] >= 80 && v[:limit] != Float::INFINITY } %>
    <% if approaching.any? %>
      <div class="alert alert-warning py-2 px-3 mt-3 mb-0">
        <small>
          <i class="bi bi-exclamation-triangle"></i>
          <%= t('usage_limits.approaching_limits_message',
                default: "You're approaching your plan limits. Consider upgrading to avoid interruptions.") %>
        </small>
      </div>
    <% end %>
  </div>
</div>
