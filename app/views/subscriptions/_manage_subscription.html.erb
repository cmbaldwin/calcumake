<%# Subscription management options %>

<div class="card border-secondary">
  <div class="card-header bg-light">
    <h3 class="h6 mb-0">
      <i class="bi bi-credit-card"></i>
      <%= t('subscriptions.manage_subscription', default: 'Manage Your Subscription') %>
    </h3>
  </div>
  <div class="card-body">
    <%# Subscription Details %>
    <% if @subscription_details %>
      <div class="mb-4">
        <h6 class="text-muted mb-3">
          <i class="bi bi-info-circle"></i>
          <%= t('subscriptions.subscription_details', default: 'Subscription Details') %>
        </h6>

        <div class="row g-3">
          <%# Current Plan %>
          <div class="col-md-4">
            <div class="border rounded p-3 h-100">
              <small class="text-muted d-block mb-1"><%= t('subscriptions.current_plan') %></small>
              <strong class="d-block h5 mb-0 text-primary"><%= current_user.plan.titleize %></strong>
            </div>
          </div>

          <%# Status %>
          <div class="col-md-4">
            <div class="border rounded p-3 h-100">
              <small class="text-muted d-block mb-1"><%= t('subscriptions.status', default: 'Status') %></small>
              <% status_variant = @subscription_details[:cancel_at_period_end] ? 'warning' : 'success' %>
              <%= render Shared::BadgeComponent.new(
                text: @subscription_details[:cancel_at_period_end] ? t('subscriptions.canceling', default: 'Canceling') : t('subscriptions.active', default: 'Active'),
                variant: status_variant
              ) %>
            </div>
          </div>

          <%# Next Billing Date %>
          <div class="col-md-4">
            <div class="border rounded p-3 h-100">
              <small class="text-muted d-block mb-1">
                <% if @subscription_details[:cancel_at_period_end] %>
                  <%= t('subscriptions.access_until', default: 'Access Until') %>
                <% else %>
                  <%= t('subscriptions.next_billing_date', default: 'Next Billing') %>
                <% end %>
              </small>
              <strong class="d-block"><%= @subscription_details[:current_period_end].strftime('%b %d, %Y') %></strong>
            </div>
          </div>

          <%# Monthly Price %>
          <% if @subscription_details[:price] %>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <small class="text-muted d-block mb-1"><%= t('subscriptions.monthly_price', default: 'Monthly Price') %></small>
                <strong class="d-block h5 mb-0">
                  <%= number_to_currency(@subscription_details[:price].unit_amount / 100.0,
                                       unit: @subscription_details[:price].currency.upcase == 'JPY' ? 'Â¥' : '$') %>
                </strong>
              </div>
            </div>
          <% end %>
        </div>

        <%# Cancellation Notice %>
        <% if @subscription_details[:cancel_at_period_end] %>
          <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle"></i>
            <%= t('subscriptions.cancel_notice',
                  default: 'Your subscription will be canceled on %{date}. You will retain access to premium features until then.',
                  date: @subscription_details[:current_period_end].strftime('%B %d, %Y')) %>
          </div>
        <% end %>
      </div>

      <hr>
    <% end %>

    <p class="mb-3">
      <%= t('subscriptions.manage_description',
            default: 'Update your payment method, view billing history, or manage your subscription through our secure billing portal.') %>
    </p>

    <div class="d-flex gap-2 flex-wrap">
      <%= link_to manage_subscriptions_path,
                  class: 'btn btn-primary',
                  data: { turbo: false } do %>
        <i class="bi bi-box-arrow-up-right"></i>
        <%= t('subscriptions.open_billing_portal', default: 'Open Billing Portal') %>
      <% end %>

      <% unless @subscription_details&.dig(:cancel_at_period_end) %>
        <%= button_to cancel_subscriptions_path,
                      method: :post,
                      class: 'btn btn-outline-danger',
                      data: {
                        confirm: t('subscriptions.cancel_confirmation',
                                  default: 'Are you sure you want to cancel your subscription? You will retain access until the end of your billing period.')
                      } do %>
          <i class="bi bi-x-circle"></i>
          <%= t('subscriptions.cancel_subscription', default: 'Cancel Subscription') %>
        <% end %>
      <% end %>
    </div>

    <div class="alert alert-info mt-3 mb-0 py-2 px-3">
      <small>
        <i class="bi bi-info-circle"></i>
        <%= t('subscriptions.manage_note',
              default: 'All billing is securely handled by Stripe. Your payment information is never stored on our servers.') %>
      </small>
    </div>
  </div>
</div>
