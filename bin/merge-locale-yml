#!/usr/bin/env ruby
# Utility for safely merging Rails locale YAML files
# Usage: bin/merge-locale-yml <base> <feature> <output>
#
# This tool performs a deep merge of two YAML locale files, preserving
# all keys from both files and properly handling nested structures.

require 'yaml'

# Deep merge extension for Hash
class Hash
  def deep_merge(other_hash)
    merge(other_hash) do |key, this_val, other_val|
      if this_val.is_a?(Hash) && other_val.is_a?(Hash)
        this_val.deep_merge(other_val)
      else
        # Prefer the feature value over base
        other_val
      end
    end
  end
end

def merge_yaml_files(base_file, feature_file, output_file)
  puts "Merging YAML files..."
  puts "  Base: #{base_file}"
  puts "  Feature: #{feature_file}"
  puts "  Output: #{output_file}"

  # Load both YAML files
  base_data = YAML.load_file(base_file)
  feature_data = YAML.load_file(feature_file)

  # Deep merge them (feature keys override base keys)
  merged_data = base_data.deep_merge(feature_data)

  # Write back with proper formatting
  File.open(output_file, 'w') do |f|
    f.write(merged_data.to_yaml)
  end

  # Verify the output is valid YAML
  YAML.load_file(output_file)

  puts "✓ Successfully merged to #{output_file}"
  puts "✓ Output validated as valid YAML"

rescue Psych::SyntaxError => e
  puts "✗ YAML syntax error: #{e.message}"
  puts "  File: #{e.file}"
  puts "  Line: #{e.line}, Column: #{e.column}"
  exit 1
rescue => e
  puts "✗ Error: #{e.message}"
  exit 1
end

# Main
if ARGV.length != 3
  puts "Usage: #{File.basename($0)} <base_file> <feature_file> <output_file>"
  puts ""
  puts "Example:"
  puts "  #{File.basename($0)} config/locales/en.yml /tmp/new_en.yml config/locales/en.yml"
  exit 1
end

merge_yaml_files(ARGV[0], ARGV[1], ARGV[2])
